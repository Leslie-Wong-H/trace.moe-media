# trace.moe-media

[![License](https://img.shields.io/github/license/soruly/trace.moe-media.svg?style=flat-square)](https://github.com/soruly/trace.moe-media/blob/master/LICENSE)
[![GitHub Workflow Status](https://img.shields.io/github/workflow/status/soruly/trace.moe-media/Node.js%20CI?style=flat-square)](https://github.com/soruly/trace.moe-media/actions)
[![Discord](https://img.shields.io/discord/437578425767559188.svg?style=flat-square)](https://discord.gg/K9jn6Kj)

### Media server for serving video preview for trace.moe

This server uses a "video scene cutter" which automatically detect timestamp boundaries of a shot, and then trim the shot out without leaking / exposing other frames that belongs to previous / next scenes. Currently this is used by the website [trace.moe](https://trace.moe) and its Telegram Bot [@whatanimebot](http://t.me/whatanimebot).

#### Background of this project

When search result from trace.moe returns an anime, episode and a timecode, it can generate a video preview for the scene at that time code.

Query image:

![](https://images.plurk.com/3F4Mg666qw78rImF7DR2SG.jpg)

Search result: `Shelter, episode 1, timecode: 00:00:51.83`

Video Preview at time `00:00:51.83`

|           Fixed offset without trace.moe-media           |             Auto detect with trace.moe-media             |
| :------------------------------------------------------: | :------------------------------------------------------: |
| ![](https://images.plurk.com/7lURadxyYVrvPl52M7mm3G.gif) | ![](https://images.plurk.com/2mcJxwtMJFSVhLQ8XDUYI3.gif) |
|            00:50.93 (-0.9) to 00:53.93 (+2.1)            |              00:49.22 to 00:51.30 (dynamic)              |

By using first / last frames from the fixed offset preview, user may be able to use that to search again and reveal previous/next scene of the original video. By repeating this process, users may eventually read the whole video until the rate limit/search quota used up.

With the video preview generated by auto detect method, searching any frame form the preview would only results the same video preview. This prevents leaking the previous/next scene.

### How does it work

To be completed
![](https://images.plurk.com/2NDcHsv4PFLWX5q64zHts7.jpg)

### Prerequisites

- Node.js 14.x
- git
- [pm2](https://pm2.keymetrics.io/) (optional)

### Install

Install Prerequisites first, then:

```
git clone https://github.com/soruly/trace.moe-media.git
cd trace.moe-media
npm install
```

### Configuration

- Copy `.env.example` to `.env`
- Edit `.env` as follows

```
VIDEO_PATH=         # e.g. /mnt/data/anilist/
SERVER_PORT=        # e.g. 3001
SERVER_ADDR=        # e.g. 127.0.0.1 or 0.0.0.0
TRACE_MEDIA_SALT=   # define any random string, or leave blank to disable secure token
TRACE_API_SECRET=   # same as TRACE_API_SECRET in trace.moe api's .env, or leave blank to disable auth
```

### Start server

```
node server.js
```

You also can use pm2 to run this in background in cluster mode.

Use below commands to start / restart / stop server.

```
npm run start
npm run stop
npm run reload
npm run restart
npm run delete
```

To change the number of nodejs instances, edit ecosystem.config.json
